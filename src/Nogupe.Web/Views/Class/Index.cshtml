@model CourseDetailViewModel

@{
    ViewData["Title"] = "Clase";
}

@{
    var role = Context.Session.GetInt32("_Role");
}

@if (role == 2)
{
    <div class="row">
        <div class="col-md-12">
            <div class="mb-1">
                <button type="button" class="btn btn-primary" onclick="openModalRating()">Cargar Notas</button>
                <button type="button" class="btn btn-primary" onclick="openModalToken()">Tomar Asistencia</button>
            </div>
            <div class="card">
                <div class="card-header" style="background-color:cadetblue">
                    <h6 class="text-white">Muro</h6>
                </div>
                <div class="card-body" style="height:400px; overflow:auto">
                    @if (Model.Comments.Count() <= 0)
                    {
                        <h5 class="text-center">¡Todavia no hay mensajes!</h5>
                    }

                    @*<div class="comments-list">
                        @foreach (var item in Model.Comments)
                        {
                            <div class="media mb-3" style="border-bottom: 1px dotted #ccc">
                                <img class="mr-3 mb-1" src="~/images/user.png" alt="user_image" width="46" height="46">
                                <div class="media-body">
                                    <a class="d-flex w-100 justify-content-between">
                                        <h5 class="mt-0">@item.Username </h5>
                                        <p class="float-right"><small> @item.Date </small></p>
                                    </a>
                                    @item.Commentary
                                </div>
                            </div>
                        }
                        </div>*@

                    <div class="comments-list">
                        @foreach (var msj in Model.Comments)
                        {
                            <a class="list-group-item flex-column align-items-start">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1"> @msj.Username </h6>
                                    <small class="text-muted"> @msj.CreatedDate </small>
                                </div>
                                <p class="mb-1"> @msj.Commentary </p>
                            </a>
                        }
                    </div>

                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <div class="input-group">
                                    <textarea class="form-control comment-text" type="text" placeholder="Escribir un comentario..." style="overflow:auto;resize:none"></textarea>
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-secondary" onclick="postComment(@Model.Id)">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header" style="background-color:cadetblue">
                    <h6 class="text-white">Archivos</h6>
                </div>
                <div class="card-body">
                    @if (Model.Files.Count() <= 0)
                    {
                        <h5 class="text-center">¡No hay archivos cargados!</h5>
                    }
                    <div class="files-list">
                        <ul class="list-group" id="fileList">
                            @foreach (var file in Model.Files)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center hidden-sm-down">
                                    @file.FileName
                                    <a asp-action="DownloadFile" asp-controller="File" asp-route-UIdFileName="@file.UIdFileName">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="card-footer">
                    <form enctype="multipart/form-data" data-ajax="true" data-ajax-success="Success" data-ajax-failure="Failure" asp-controller="File" asp-action="UploadFile">
                        <input hidden name="WallId" value="@Model.Id" />
                        <div class="custom-file">
                            <input type="file" name="File" class="custom-file-input" id="customFile">
                            <label class="custom-file-label" for="customFile">Seleccioné archivo</label>
                        </div>
                        <button type="submit" class="btn btn-link">Cargar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
else if (role == 3)
{
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="text-center"><i class="fas fa-align-justify mr-1"></i>Muro</h6>
                    <button type="button" class="btn btn-primary" onclick="openModalMyRating()">Mis notas</button>
                    <button type="button" class="btn btn-primary" onclick="openModalMyAssintance()">Dar asistencia</button>
                </div>
                <div class="card-body" style="height:400px; overflow:auto">
                    @if (Model.Comments.Count() <= 0)
                    {
                        <h5 class="text-center">¡Todavia no hay mensajes!</h5>
                    }
                    <div class="comments-list">
                        @foreach (var msj in Model.Comments)
                        {
                            <a class="list-group-item flex-column align-items-start">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1"> @msj.Username </h6>
                                    <small class="text-muted"> @msj.CreatedDate </small>
                                </div>
                                <p class="mb-1"> @msj.Commentary </p>
                            </a>
                        }
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-12">
                            <form  data-ajax="true" data-ajax-success="Success" data-ajax-failure="Failure" asp-action="PostComment" asp-controller="Class" asp-route-id="@Model.Id">
                                <div class="form-group">
                                    <div class="input-group">
                                        <textarea class="form-control comment-text" name="Commentary" type="text" placeholder="Escribir un comentario..." style="overflow:auto;resize:none"></textarea>
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-secondary">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}



<!-- Modal Asistencias -->
<!--<div class="modal fade" id="assistanceModal" role="dialog" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="text-center">Asistencia</h5>
                <a href="#" class="close" data-dismiss="modal">&times;</a>
            </div>
            <div class="modal-body assistance-content">
                <form method="post" id="formToken" asp-action="Assistance" asp-controller="Courses">
                    <div class="form-group">
                        @Html.Label("Codigo Token")
                        @Html.TextBox("Token", "", new { @class = "form-control" })
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success" onclick="assistanceToken()">Dar asistencia</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>-->

<!-- Modal Calificaciones -->
<div class="modal fade" id="ratingStudents" role="dialog" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Listado de Notas</h5>
                <a href="#" class="close" data-dismiss="modal">&times;</a>
            </div>
            <div class="modal-body">
                <table class="table" id="table-form">
                    <thead class="thead-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Nota 1º</th>
                            <th>Nota 2º</th>
                            <th>Nota Final</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.Ratings)
                        {
                            <tr>
                                <td> 
                                    <input type="hidden" id="alumnoId" value="@user.Id" />
                                    @user.Username 
                                </td>
                                <td><input type="number" min="0" max="10" id="nota1" required></td>
                                <td><input type="number" min="0" max="10" id="nota2" required></td>
                                <td><input type="number" min="0" max="10" id="nota3" required></td>
                                <td><button type="submit" class="btn btn-success" onclick="LoadRating()">Cargar</button></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script>
        function openModalRating() {
            $('#ratingStudents').modal('show');
        };

        function LoadRating() {
            var id = $('#alumnoId').val();
            var nota1 = $('#nota1').val();
            var nota2 = $('#nota2').val();
            var nota3 = $('#nota3').val();

            var formData = {
                Id: id,
                OnePartial: nota1,
                TwoPartial: nota2,
                FinalNote: nota3
            };

            $.ajax({
                type: 'Put',
                url: "@Url.Action("UpdateRating", "Class")",
                data: formData,
                success: function (res) {
                    console.log(res);
                },
                error: function (xhr, status) {
                    alert('Disculpe, existió un problema');
                }
            });
        };

        function Success(xhr) {
            console.log(xhr)
            var data = xhr;
            var files = $("#fileList");
            files.append('<li class="list-group-item d-flex justify-content-between align-items-center hidden-sm-down">' + data.fileName + '<a href="/File/DownloadFile?UIdFileName=' + data.uIdFileName + '">' + '<i class="fas fa-download"></i ></a></li>');
        };

        function Failure(xhr) {
            $.toast({
                text: `Error: Debe cargar algun archivo`,
                hideAfter: 3000,
                allowToastClose: true,
                showHideTransition: 'fade',
                position: 'bottom-center',
                icon: 'error'
            });
        };


        $(document).ready(function () {
            //setInterval(updateCommentsList, 3000);
            $.ajaxSetup({ cache: false });

            // nombre de archivo subido
            $(".custom-file-input").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
            });

        });
       
        //function openModalMyAssintance() {
        //    $('#assistanceModal').modal('show');
        //};

        function updateCommentsList() {
            var location = window.location.pathname;
            var courseId = parseInt(location.substring(location.length - 1));

            $.ajax({
                type: 'Get',
                url: "@Url.Action("Comments", "Class")",
                data: { id: courseId },
                success: function (res) {
                    var lista = $('.comments-list');
                    lista.empty();
                    $.each(res.comments, function (e, i) {
                        var hourFormat = moment(new Date(i.date)).format("MM/DD/YYYY h:mm:ss A");
                        lista.append('<a class="list-group-item flex-column align-items-start"> <div class="d-flex w-100 justify-content-between"> <h6 class="mb-1">' + i.username + '</h6> <small class="text-muted"> ' + hourFormat + ' </small> </div><p class="mb-1">' + i.commentary + '</p></a>');
                    });
                }
            });
        }

        function postComment(id) {
            var mensaje = $(".comment-text");
            var comentarios = $(".comments-list");
            var url = "@Url.Action("PostComment", "Class")"

            var model = {
                WallId : id,
                Commentary: mensaje.val(),
            };

            $.ajax({
                type: 'POST',
                url: url,
                data: model,
                success: function (res) {
                    var hora = moment(new Date(res.date)).format("MM/DD/YYYY h:mm:ss A");
                    comentarios.append('<a class="list-group-item flex-column align-items-start" id="message_' + res.id + '"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">' + res.userName + '</h6><small class="text-muted">' + hora + '</small></div><p class="mb-1">' + res.commentary + '</p></a>');
                    mensaje.val("");
                    updateCommentsList();
                },
                error: function (xhr, status) {
                    alert('Disculpe, existió un problema');
                }
            });
        }

</script>
}